# MCP Function Calling Architecture

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      CLIENT APPLICATION                           â”‚
â”‚              (Electron App / cURL / Python Client)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ HTTP Request
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     FastAPI SERVER                                â”‚
â”‚                (python/nvidia_rag_service.py)                     â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ENDPOINTS                                                   â”‚ â”‚
â”‚  â”‚  â€¢ GET  /health          - Service status + MCP info        â”‚ â”‚
â”‚  â”‚  â€¢ GET  /mcp/tools       - List available tools             â”‚ â”‚
â”‚  â”‚  â€¢ POST /query           - Standard RAG                     â”‚ â”‚
â”‚  â”‚  â€¢ POST /query-structured - RAG with citations              â”‚ â”‚
â”‚  â”‚  â€¢ POST /query-agent     - Agent with tool calling â­       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                            â”‚                                       â”‚
â”‚                            â–¼                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  NVIDIA AI MODELS                                            â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚ NVIDIAEmbeddings                                     â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ nvidia/llama-3.2-nemoretriever-300m-embed-v2        â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Input: Text documents                              â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Output: 300M param embeddings                      â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚                            â”‚                                  â”‚ â”‚
â”‚  â”‚                            â–¼                                  â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚ ChatNVIDIA (with Function Calling)                   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ moonshotai/kimi-k2-instruct                         â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ temperature: 0.6                                   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ top_p: 0.9                                         â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ max_tokens: 4096                                   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ tool_choice: "auto" ğŸ”§                             â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                            â”‚                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                   â”‚                   â”‚
         â–¼                   â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ChromaDB    â”‚  â”‚  MCP Client      â”‚  â”‚  Pydantic        â”‚
â”‚  Vector DB   â”‚  â”‚  (Tool Loader)   â”‚  â”‚  Validators      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Persistent â”‚  â”‚ â€¢ MultiServer    â”‚  â”‚ â€¢ StructuredAnswerâ”‚
â”‚ â€¢ Semantic   â”‚  â”‚ â€¢ Async Loading  â”‚  â”‚ â€¢ Citations      â”‚
â”‚   Search     â”‚  â”‚ â€¢ Tool Binding   â”‚  â”‚ â€¢ Key Points     â”‚
â”‚ â€¢ 1024D      â”‚  â”‚ â€¢ 3 Transports:  â”‚  â”‚ â€¢ Confidence     â”‚
â”‚   Vectors    â”‚  â”‚   - stdio        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚              â”‚  â”‚   - HTTP/SSE     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   - WebSocket    â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   MCP SERVERS           â”‚
              â”‚   (External Services)    â”‚
              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
              â”‚ â€¢ Filesystem            â”‚
              â”‚ â€¢ GitHub                â”‚
              â”‚ â€¢ Google Drive          â”‚
              â”‚ â€¢ Database              â”‚
              â”‚ â€¢ Custom Tools          â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Request Flow: Agent with Tool Calling

```
1. CLIENT REQUEST
   POST /query-agent
   {
     "question": "Analyze src/ files and summarize classes",
     "use_rag": true,
     "max_iterations": 10
   }
   
        â†“

2. RAG CONTEXT (if use_rag=true)
   â€¢ ChromaDB similarity search
   â€¢ Retrieve top_k relevant documents
   â€¢ Embed context into prompt
   
        â†“

3. AGENT INITIALIZATION
   messages = [
     {
       "role": "user",
       "content": "Analyze src/ files...\n\n[RAG Context]"
     }
   ]
   
        â†“

4. ITERATION 1: LLM DECISION
   llm_with_tools.invoke(messages)
   
   Response: {
     "tool_calls": [{
       "name": "list_directory",
       "args": {"path": "src/"}
     }]
   }
   
        â†“

5. TOOL EXECUTION
   â€¢ Find tool in mcp_tools
   â€¢ Execute: mcp_tool.ainvoke({"path": "src/"})
   â€¢ Result: "['agent/', 'rag/', 'models/']"
   
        â†“

6. APPEND TOOL RESULT
   messages.append({
     "role": "tool",
     "content": "['agent/', 'rag/', 'models/']",
     "tool_call_id": "call_123"
   })
   
        â†“

7. ITERATION 2: LLM DECISION
   llm_with_tools.invoke(messages)
   
   Response: {
     "tool_calls": [{
       "name": "read_file",
       "args": {"path": "src/agent/StudyAgentService.ts"}
     }]
   }
   
        â†“

8. REPEAT TOOL EXECUTION...
   (Continue until max_iterations or final answer)
   
        â†“

9. ITERATION N: FINAL ANSWER
   llm_with_tools.invoke(messages)
   
   Response: {
     "content": "I found 3 main classes in src/:\n
                 1. StudyAgentService - handles agent logic\n
                 2. NvidiaEmbeddings - embedding generation\n
                 3. RAGClient - vector store interface"
   }
   
        â†“

10. RETURN TO CLIENT
    {
      "answer": "I found 3 main classes...",
      "tool_calls": [
        {"name": "list_directory", "result": "..."},
        {"name": "read_file", "result": "..."}
      ],
      "sources": [...],
      "iterations": 3
    }
```

## Data Flow Diagram

```
USER INPUT
    |
    v
[Question + Config]
    |
    v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RAG Pipeline  â”‚ (Optional)
â”‚ - Embeddings  â”‚
â”‚ - Vector DB   â”‚
â”‚ - Retrieval   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        |
        v
[Question + RAG Context]
        |
        v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     AGENT LOOP (up to 10 iterations)  â”‚
â”‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  1. LLM Decision                â”‚ â”‚
â”‚  â”‚     "Need tool?" or "Answer?"   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         |                             â”‚
â”‚    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                        â”‚
â”‚    |  Tool?  |                        â”‚
â”‚    â””â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”˜                        â”‚
â”‚     |Yes    |No                       â”‚
â”‚     v       v                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚Executeâ”‚ â”‚  Final   â”‚               â”‚
â”‚  â”‚ Tool  â”‚ â”‚  Answer  â”‚               â”‚
â”‚  â””â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜               â”‚
â”‚     |          |                      â”‚
â”‚  â”Œâ”€â”€vâ”€â”€â”€â”€â”€â”€â”  |                      â”‚
â”‚  â”‚ Append  â”‚  |                      â”‚
â”‚  â”‚ Result  â”‚  |                      â”‚
â”‚  â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  |                      â”‚
â”‚     |          |                      â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚         |                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          |
          v
    [Final Answer]
          |
          v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Format Response    â”‚
â”‚  â€¢ answer           â”‚
â”‚  â€¢ tool_calls log   â”‚
â”‚  â€¢ sources          â”‚
â”‚  â€¢ iterations       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          |
          v
    [JSON Response]
          |
          v
       CLIENT
```

## MCP Tool Discovery Flow

```
SERVICE STARTUP
      |
      v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  initialize_nvidia_clients()        â”‚
â”‚                                     â”‚
â”‚  1. Init NVIDIAEmbeddings           â”‚
â”‚  2. Init ChatNVIDIA                 â”‚
â”‚  3. Load MCP tools â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”˜
                              |
                              v
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ load_mcp_tools()    â”‚
                    â”‚ (async)             â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               |
                               v
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ MultiServerMCPClient       â”‚
              â”‚                            â”‚
              â”‚ MCP_SERVERS = {            â”‚
              â”‚   "filesystem": {...},     â”‚
              â”‚   "github": {...}          â”‚
              â”‚ }                          â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       |
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        |              |              |
        v              v              v
   [Server 1]     [Server 2]     [Server 3]
   (stdio)        (HTTP/SSE)     (WebSocket)
        |              |              |
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       |
                       v
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ await client   â”‚
              â”‚ .get_tools()   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                       |
                       v
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ mcp_tools = [                â”‚
        â”‚   {name: "read_file", ...},  â”‚
        â”‚   {name: "write_file", ...}, â”‚
        â”‚   {name: "list_dir", ...}    â”‚
        â”‚ ]                            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   |
                   v
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ llm_with_tools =               â”‚
      â”‚   llm.bind_tools(              â”‚
      â”‚     mcp_tools,                 â”‚
      â”‚     tool_choice="auto"         â”‚
      â”‚   )                            â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   |
                   v
            [Tools Ready! ğŸ‰]
```

## Technology Stack

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  APPLICATION LAYER                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ FastAPI (REST API)                       â”‚
â”‚  â€¢ Uvicorn (ASGI Server)                    â”‚
â”‚  â€¢ Pydantic (Data Validation)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AI/ML LAYER                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ langchain-nvidia-ai-endpoints            â”‚
â”‚  â€¢ langchain-mcp-adapters                   â”‚
â”‚  â€¢ langchain-core                           â”‚
â”‚  â€¢ langgraph                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STORAGE LAYER                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ ChromaDB (Vector Database)               â”‚
â”‚  â€¢ SQLite (ChromaDB Backend)                â”‚
â”‚  â€¢ Persistent Disk Storage                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  EXTERNAL SERVICES                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ NVIDIA NIM API (Embeddings + Chat)       â”‚
â”‚  â€¢ MCP Servers (Tools)                      â”‚
â”‚  â€¢ Document Loaders (PyPDF)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Key Components

| Component | Purpose | Technology |
|-----------|---------|------------|
| **Embeddings** | Semantic text encoding | nvidia/llama-3.2-nemoretriever-300m-embed-v2 |
| **Chat Model** | LLM with function calling | moonshotai/kimi-k2-instruct |
| **Vector DB** | Persistent semantic search | ChromaDB (persistent mode) |
| **MCP Client** | Tool discovery & execution | langchain-mcp-adapters |
| **Agent** | Agentic workflow orchestration | Custom loop with tool calling |
| **API Layer** | REST endpoints | FastAPI + Uvicorn |

## Performance Characteristics

```
Operation                 | Latency      | Notes
--------------------------|--------------|------------------
Health Check              | <50ms        | No AI calls
MCP Tools List            | <100ms       | Cached after load
Document Upload (1MB PDF) | ~2-5s        | Embedding generation
Query (no tools)          | ~1-2s        | LLM inference
Query (structured)        | ~1.5-2.5s    | +parsing overhead
Query (agent, 3 tools)    | ~5-10s       | Multiple LLM calls
Tool Execution (local)    | ~100-500ms   | File I/O
Tool Execution (remote)   | ~500-2000ms  | Network latency
```

## Security Considerations

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SECURITY LAYERS                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. API Key Authentication          â”‚
â”‚     â€¢ NVIDIA_API_KEY env var        â”‚
â”‚     â€¢ Never exposed to client       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  2. CORS Configuration              â”‚
â”‚     â€¢ Configurable origins          â”‚
â”‚     â€¢ Production: whitelist only    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  3. MCP Server Authentication       â”‚
â”‚     â€¢ Bearer tokens for HTTP        â”‚
â”‚     â€¢ Path restrictions for stdio   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  4. Input Validation                â”‚
â”‚     â€¢ Pydantic schemas              â”‚
â”‚     â€¢ Max iteration limits          â”‚
â”‚     â€¢ File path sanitization        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  5. Rate Limiting (TODO)            â”‚
â”‚     â€¢ Per-IP limits                 â”‚
â”‚     â€¢ API key quotas                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Deployment Options

```
Development:
  python nvidia_rag_service.py
  â€¢ Local only
  â€¢ Debug logging
  â€¢ Auto-reload

Production:
  uvicorn nvidia_rag_service:app \
    --host 0.0.0.0 \
    --port 8000 \
    --workers 4 \
    --log-level info
  
Docker:
  docker build -t rag-service .
  docker run -p 8000:8000 \
    -e NVIDIA_API_KEY=xxx \
    -v ./chroma_db:/app/chroma_db \
    rag-service
```

This architecture provides a production-ready, scalable RAG system with advanced MCP tool integration!
