name: Build and Release macOS

on:
  push:
    tags:
      - "v*.*.*" # Trigger on version tags like v1.0.0
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write  # Required for creating releases

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install Node dependencies
        run: npm ci --legacy-peer-deps
        continue-on-error: false
        env:
          SKIP_POSTINSTALL: "true"

      - name: Setup Python environment with uv
        run: |
          echo "ðŸ Creating virtual environment with uv..."
          uv venv .venv --python 3.12
          echo "ðŸ“š Installing Python dependencies..."
          uv pip install -r python/requirements.txt --python .venv/bin/python
          echo "ðŸ§ª Verifying installation..."
          .venv/bin/python -c "import chromadb; print(f'âœ… ChromaDB installed')"
          .venv/bin/python -c "import langchain_nvidia_ai_endpoints; print('âœ… NVIDIA AI Endpoints installed')"

      - name: Rebuild native modules for Electron
        run: |
          npm rebuild better-sqlite3 --build-from-source
          npm rebuild chromadb --build-from-source

      - name: Build MCP server
        run: npm run build:mcp

      - name: Create env template for packaging
        run: |
          if [ ! -f .env ]; then
            cp .env.example .env || echo 'NVIDIA_API_KEY="your-key-here"' > .env
          fi

      - name: Package application
        run: npm run make

      - name: List built files
        run: |
          echo "ðŸ“¦ Built files:"
          find out/make -type f -name "*.dmg" -o -name "*.zip"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            out/make/**/*.dmg
            out/make/**/*.zip
          draft: false
          prerelease: false
          generate_release_notes: true
          fail_on_unmatched_files: false
          body: |
            ## ðŸŽ‰ macOS Release

            ### Installation
            1. Download the `.dmg` file
            2. Open it and drag the app to Applications
            3. First launch: Right-click â†’ Open (to bypass Gatekeeper if not signed)

            ### Features
            - âœ… Python virtual environment included
            - âœ… All native modules compiled for macOS
            - âœ… RAG service with NVIDIA API support
            - âœ… ChromaDB vector storage

            ### Requirements
            - macOS 11.0 (Big Sur) or later
            - No additional dependencies needed!
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-app
          path: out/make/
          retention-days: 7
